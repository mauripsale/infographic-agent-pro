name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  BACKEND_SERVICE_NAME: infographic-agent-backend

jobs:
  # 1. TEST & LINT (Sempre in esecuzione)
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    # Backend CI
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    - name: Install Python Dependencies
      run: pip install -r backend/requirements.txt
    - name: Lint Backend
      working-directory: ./backend
      run: |
        pip install flake8
        flake8 main.py script_agent visual_agent --count --select=E9,F63,F7,F82 --show-source --statistics

    # Frontend CI
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "18"
        cache: "npm"
        cache-dependency-path: frontend/package-lock.json
    - name: Install NPM Dependencies
      working-directory: ./frontend
      run: npm ci
    - name: Build Frontend (Check)
      working-directory: ./frontend
      run: npm run build
      env:
        VITE_GEMINI_API_KEY: "dummy"

  # 2. DEPLOY (Solo su push a main)
  deploy:
    name: Continuous Deployment
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # Authenticate with Google Cloud using Workload Identity Federation
    - id: 'auth'
      uses: 'google-github-actions/auth@v1'
      with:
        workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
        service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'

    # Setup gcloud CLI
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    # --- DEPLOY BACKEND (Cloud Run) ---
    - name: Build and Push Backend Image
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
        # Build from backend directory context
        docker build -f backend/Dockerfile -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE_NAME }}/${{ env.BACKEND_SERVICE_NAME }}:${{ github.sha }} backend/
        docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE_NAME }}/${{ env.BACKEND_SERVICE_NAME }}:${{ github.sha }}

    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v1
      with:
        service: ${{ env.BACKEND_SERVICE_NAME }}
        image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE_NAME }}/${{ env.BACKEND_SERVICE_NAME }}:${{ github.sha }}
        region: ${{ env.REGION }}
        flags: '--allow-unauthenticated --max-instances=1'

    # --- DEPLOY FRONTEND (Firebase Hosting) ---
    - name: Build and Deploy Frontend
      working-directory: ./frontend
      run: |
        npm ci
        # Build without pre-set API keys to force UI prompt for user key
        npm run build
      env:
        # Firebase Config (Public values needed for client-side auth)
        # TODO: Move these to GitHub Secrets for better security hygiene, although they are public in client code.
        VITE_FIREBASE_API_KEY: "AIzaSyBZJOqyLOu7KK2yoRP5GKpl2TFSYKGf4bI"
        VITE_FIREBASE_AUTH_DOMAIN: "qwiklabs-asl-04-f9d4ba2925b9.firebaseapp.com"
        VITE_FIREBASE_PROJECT_ID: "qwiklabs-asl-04-f9d4ba2925b9"
        VITE_FIREBASE_STORAGE_BUCKET: "qwiklabs-asl-04-f9d4ba2925b9.firebasestorage.app"
        VITE_FIREBASE_MESSAGING_SENDER_ID: "218788847170"
        VITE_FIREBASE_APP_ID: "1:218788847170:web:5cb315322d8129984bd7db"
        VITE_FIREBASE_MEASUREMENT_ID: "G-FJVR1SD5T4"
    
    - name: Firebase Deploy
      uses: w9jds/firebase-action@master
      with:
        args: deploy --only hosting
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        PROJECT_PATH: ./frontend
