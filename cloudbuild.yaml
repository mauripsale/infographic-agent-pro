steps:
  # 1. Build and Push with Kaniko Cache
  - name: 'gcr.io/kaniko-project/executor:v1.23.0'
    args:
      - '--destination=${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/infographic-agent-backend:$SHORT_SHA'
      - '--cache=true'
      - '--cache-ttl=24h'
      - '--context=dir:///workspace/backend'
    id: 'Build & Push (Kaniko)'

  # 2. Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'infographic-agent-backend'
      - '--image=${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REPO}/infographic-agent-backend:$SHORT_SHA'
      - '--region=${_REGION}'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--set-env-vars=ENCRYPTION_KEY=${_ENCRYPTION_KEY},GCS_BUCKET_NAME=${_GCS_BUCKET_NAME},GOOGLE_CLOUD_PROJECT=${PROJECT_ID}'
    id: 'Deploy to Cloud Run'

timeout: '1200s'
options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: "us-central1"
  _ARTIFACT_REPO: "cloud-run-source-deploy"
  _ENCRYPTION_KEY: ""
  _GCS_BUCKET_NAME: ""